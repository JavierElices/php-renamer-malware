#!/usr/bin/perl
# Checks the file structure of a web site to ensure it has not been infected
#
# Uso: check-site.pl <web root directory>

use strict;
use warnings;


# Check the number of arguments
if( $#ARGV != 0 ) {
  print "Uso:\n$0 <web root directory>\n";
  exit 0;
}
my $home = shift;

if( !-d $home ) {
  die "$home: not a directory\n";
}

chdir $home;

my $check;
# find . -name '*.suspected' -print | grep '.'
$check = qx(find . -name '*.suspected' -print | grep '.');
if( $? == 0 ) {
  print "Possible affected files (.suspected) found at $home:\n", $check, "\n";
}

# find . -name '.*.ico' -print | grep '.'
$check = qx(find . -name '.*.ico' -print | grep '.');
if( $? == 0 ) {
  print "Possible infected files (.ico) found at $home:\n", $check, "\n";
}

# egrep -Rl '\$GLOBALS.*\\x'
$check = qx(egrep -Rl '\\\$GLOBALS.*\\\\x');
if( $? == 0 ) {
  print "Possible infected files (\$GLOBALS) found at $home:\n", $check, "\n";
}

# egrep -Rl -Ezo '/\*(\w+)\*/\s*@include\s*[^;]+;\s*/\*'
$check = qx(egrep -Rl -Ezo '/\\*(\\w+)\\*/\\s*\@include\\s*[^;]+;\\s*/\\*');
if( $? == 0 ) {
  print "Possible infected files (\@include) found at $home:\n", $check, "\n";
}

# egrep -Rl -E '^.+(\$_COOKIE|\$_POST).+eval.+$'
$check = qx(egrep -Rl -E '^.+(\\\$_COOKIE|\\\$_POST).+eval.+\$');
if( $? == 0 ) {
  print "Possible infected files (COOKIE|POST + eval) found at $home:\n", $check, "\n";
}
